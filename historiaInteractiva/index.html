
<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
  </head>
  <body>
  </body>
  <script>
    const lang = "es";
    const options = {"typewriterSpeed":20,"adventureSlide":false,"adventureScroll":false,"evalTags":false,"backBtn":true,"restartBtn":true,"defaultCSS":true}
    options.defaultCSS = false;
    options.sceneCallback =  function(e) {
      if (this.prevScene === undefined) this.prevScene = [];
      const backSymbol = "<--";
      const restartSymbol = "Reiniciar";
      if (this.backBtn && this.prevScene.length > 0 && this.topScene !== e.key) {
        if (this.prevScene[this.prevScene.length - 2] === e.key) {
          this.prevScene = this.prevScene.slice(0, - 2);
        }
        if (e.options !== undefined) {
          // Ya hay lista de botones
          const found = e.options.find(d => d.btn === backSymbol);
          if (found === undefined) {
            e.options.push({btn: backSymbol, scene: this.prevScene[this.prevScene.length - 1]}); // Añadir un nuevo botón
          } else {
            // Actualizar el botón que ya existe
            found.scene = this.prevScene[this.prevScene.length - 1];
          }
        } else {
          // No hay lista de opciones, crear una nueva
          e.options = [];
          e.options.push({btn: backSymbol, scene: this.prevScene[this.prevScene.length - 1]});
        }
      }
      this.prevScene.push(e.key);
      
      if (this.topScene === undefined) { this.topScene = e.key }
      if (this.restartBtn && (this.topScene !== undefined) && this.topScene !== e.key) {
        if (e.options !== undefined) {
          if (e.options.filter(d => d.btn === restartSymbol).length < 1) {
            e.options.push({btn: restartSymbol, scene: this.topScene});
          }
        } else {
          e.options = [];
          e.options.push({btn: restartSymbol, scene: this.topScene});
        }
      }
    }
  </script>
  <style>
    
  #storygeneraldiv {
    box-sizing: border-box;
    margin: auto;
    max-width: 600px;
    font-family: 'Courier New', Courier, monospace;
    background: white;
  }
  
  .storydiv {
    border: solid black 1px;
    width: 100%;
    display: flex;
    padding: 10px;
    flex-direction: column;
    box-sizing: border-box;
  }
  
  .storyp {
    font-size: 18px;
    min-height: 25px;
  }
  
  .storybutton-container {
    margin: auto;
  }
  
  .storybutton {
    background: white;
    box-shadow: none;
    border: solid 1px;
    margin: 0px 1em 0px 0px;
    font-size: 20px;
    font-family: 'Courier New', Courier, monospace;
    cursor: pointer;
  }
  
  .storybutton:hover {
    color: white;
    background: black;
  }
  
  .storyimage-container {
    box-sizing: content-box;
    position: relative;
    width: 100%;
    margin: auto;
  }
  
  .storyimage {
    justify-content: center;
    width: 100%;
    margin: auto;
    border-radius: 20px;
    display: block;
  }
  
  .storyimage-area {
    font-size: 14px;
    position: absolute;
    cursor: pointer;
    text-align: center;
    color: black;
    background: #ffffff00;
    border: solid 1px black;
  }
  
  .storyimage-area:hover {
    background: #ffffff33;
  }
  
  @media screen and (max-device-width: 500px) {
    #storygeneraldiv {
      max-width:100%;
    }
    .storyp {
      font-size: 7vw;
    }
    .storybutton {
      font-size: 10vw;
    }
  }
  
  </style>
  <script>
    const A = class sn{constructor(e="en",t){this.lang=e==="en"||e==="es"?e:"en",this.options={typewriterSpeed:50,defaultCSS:!0,adventureContainer:void 0,adventureScroll:!1,adventureSlide:!0,evalTags:!1,igramaFormat:"png",urlWord:"URL",vizWidth:1e3,vizHeight:1e3,vizBg:"#313131",vizCol:"black",vizImageSize:50,vizLoading:!0,minigifOptions:{},sceneCallback:n=>n},t&&(this.options=Object.assign(this.options,this.setOptionsTranslations(t))),this.grammarError=!1,this.scenesError=!1,this.fijarGramatica=this.setGrammar,this.expandirGramatica=this.expandGrammar,this.probarGramatica=this.testGrammar,this.fijarEscenas=this.setScenes,this.fijarDatosEscenas=this.setDataScenes,this.iniciarAventura=this.startAdventure,this.probarEscenas=this.testScenes,this.cargarJSON=this.loadJSON,this.modeloMarkov=this.getMarkovModel,this.fijarMarkov=this.setMarkov,this.cadenaMarkov=this.markovChain,this.probarDistribucion=this.testDistribution,this.markovSeparator=/[^\S\r\n]+/i,this.fijarIgrama=this.setIgrama,this.expandirIgrama=this.expandIgrama,this.mostrarIgrama=this.showIgrama,this.textoIgrama=this.getIgramaText,this.imgsMemo={},this.storyPreload={}}setOptionsTranslations(e){const t={velocidadMaquina:"typewriterSpeed",CSSporDefecto:"defaultCSS",contenedorAventura:"adventureContainer",rolloAventura:"adventureScroll",deslizarAImagen:"adventureSlide",ejecutarEtiquetas:"evalTags",formatoIgrama:"igramaFormat",palabraUrl:"urlWord",anchoVis:"vizWidth",altoVis:"vizHeight",fondoVis:"vizBg",colorVis:"vizCol",tamanoImagenVis:"visImageSize",cargandoVis:"vizLoading",opcionesMinigif:"minigifOptions",funcionEscena:"sceneCallback"};for(let[n,o]of Object.entries(e))t[n]!==void 0&&(e[t[n]]=o,delete e[n]);return e}setGrammar(e){return this.grammar=e,this}setIgrama(e){this.igrama=e;for(let[t,n]of Object.entries(e.grammar));return this}setScenes(e){this.options.defaultCSS&&this.setCSS(),this.scenes=e;for(let t of Object.keys(e)){this.scenes[t].key=t;const n=this.scenes[t].image||this.scenes[t].imagen;n!==void 0&&this.storyPreload[n]===void 0&&(this.storyPreload[n]=new Image,this.storyPreload[n].src=n,this.storyPreload[n].className="storyimage")}return this}async setDataScenes(e,t=void 0,n=[]){if(this.options.defaultCSS&&this.setCSS(),typeof d3>"u"){console.error(this.lang==="es"?"Para crear visualizaciones debes tener también la librería D3":"To create visualizations you must have also the D3 library");return}return this.scenes=JSON.parse(JSON.stringify(e)),this.metaKeys=n,t!==void 0&&(this.data=JSON.parse(JSON.stringify(t)),await this.setViz(this.scenes,this.data)),this.setScenes(this.scenes),this}async setViz(e,t){const n=Object.keys(e),o={compare:on,scatter:rn,pack:ln};let i=0;for(let u of n)e[u].viz!==void 0&&i++;let r=0,l;const a=this.lang==="en"?"Loading...":"Cargando...";this.options.vizLoading&&(l=document.createElement("div"),l.id="storygeneraldiv",l.className="storydiv",l.textContent=a,(this.options.adventureContainer!==void 0?document.getElementById(this.options.adventureContainer):document.body).appendChild(l));function f(u,c=15){let d="";for(let h=0;h<Math.ceil(c);h++)d+=h<u*c?"|":"-";return d}for(let u of n){if(e[u].viz===void 0)continue;const{filter:c,type:d,x:h,y:S}=e[u].viz;if(o[d]===void 0||h===void 0||S===void 0){const b=this.lang==="es"?`Parámetros incorrectos de visualización en la escena "${u}"`:`Incorrect parameteres in the scene "${u}"`;console.error(b)}let w=t;for(let b of c)w=this.filterFn(b)(w);let E=r;const{viz:y,areas:m}=await o[d](this,w,h,S,b=>{r=E+b/i;const g=Math.ceil(r*100);this.options.vizLoading&&(l.textContent=`${a} ${f(r)} ${g}%`)});e[u].image=y,e[u].areas=m}for(let u of t){if(u.ID===void 0){const c=this.lang==="es"?"Todos los datos deben tener un valor único con la clave ID":"All data must have a unique value with the ID key";console.error(c),this.scenes={};break}e[`ind_${u.ID}`]={text:`${u.CONT||""}`,meta:u.ID,dataScene:!0,options:[{btn:"<<<",scene:`ind_${u.ID}`}]},u.IMGURL!==void 0&&(e[`ind_${u.ID}`].image=u.IMGURL),u.URL!==void 0&&(e[`ind_${u.ID}`].url=u.URL)}l.remove()}filterFn(e){const t=e[1];if(t==="="||t==="=="||t==="===")return o=>o.filter(i=>n(i[e[0]])==n(e[2]));return t==="<"?o=>o.filter(i=>n(i[e[0]])<n(e[2])):t===">"?o=>o.filter(i=>n(i[e[0]])>n(e[2])):o=>o;function n(o){return o==="true"?!0:o==="false"?!1:o}}setMarkov(e){return this.markov=e,this}expandGrammar(e){const t=this.selectGrammarRule(this.grammar[e]);return this.grammarRuleRecursion(t)}expandIgrama(e){const t=this.igrama.grammar,n=this.selectGrammarRule(t[e]);return this.grammarRuleRecursion(n,t).split("|").map(i=>this.decodeDrawing(i))}grammarRuleRecursion(e,t){let n=t||this.grammar,o=this.setNewRules(e);const i=o.match(/<[\w\d.,/#]+>/gi);if(!i)return o;for(let r of i){const l=this.defineTransformations(r);o=o.replace(r,()=>{r=r.replace(/[<>]/gi,""),r=r.replace(/#[\w\d.,/]+#/g,"");const a=r.search(/[.]/)>-1?this.getNestedObject(n,r.match(/[\w\d]+/g)):n[r];if(!a){const u=this.lang==="es"?`Se intentó expandir desde la regla "${r}", pero no se pudo encontrar`:`Tried to expand from rule "${r}", but couldn't find it`;console.error(u)}const f=this.selectGrammarRule(a);return this.transformString(f,l)})}return this.grammarRuleRecursion(o,n)}setNewRules(e,t){let n;t===void 0?n=this.grammar:n=t;let o=e;const i=o.match(/\$[\w\d]+\$\[[\w\d:,-]+\]/ig);if(i)for(;i.length;){const r=i.pop();o=o.replace(r,"");const{symbol:l,pairsString:a}=/\$(?<symbol>[\w\d]+)\$\[(?<pairsString>[\w\d:,-]+)\]/i.exec(r).groups,f=a.match(/[-]?[\w\d]+:[\w\d]+/gi).map(u=>/(?<remove>[-]?)(?<key>[\w\d]+)[ ]?:[ ]?(?<value>[\w\d]+)/gi.exec(u).groups);if(f){n[l]=n[l]||{};for(let u of f){const c=n[u.value];if(!c){const S=this.lang==="es"?`Se intentó crear la nueva regla "${l}", pero no se pudo encontrar "${u.value}" para producir la subregla "${u.key}"`:`Tried to create new rule: "${l}", but couldn't find "${u.value}" to produce "${u.key}" subrule`;console.error(S)}const d=u.remove==="-",h=this.selectGrammarRule(c);if(d){const S=c.indexOf(h);n[u.value]=[...c.slice(0,S),...c.slice(S+1)]}n[l][u.key]=[h]}}}return o}startAdventure(e){const t=document.createElement("div");return t.id="storygeneraldiv",(this.options.adventureContainer!==void 0?document.getElementById(this.options.adventureContainer):document.body).appendChild(t),this.prevScene=e,this.goToScene(this.scenes[e]),this}goToScene(e){const t=document.getElementById("storygeneraldiv");(!this.options.adventureScroll||e.plop===!0)&&[...document.getElementsByClassName("storydiv")].map(a=>a.remove()),[...document.getElementsByClassName("storyimage-area")].map(l=>l.remove());const o=document.createElement("div");if(o.className="storydiv",t.appendChild(o),e.image||e.imagen){const l=document.createElement("div");l.className="storyimage-container",o.appendChild(l);const a=e.image||e.imagen,f=this.options.adventureScroll?this.storyPreload[a].cloneNode():this.storyPreload[a];l.appendChild(f),e.areas&&(f.complete?this.setAreas(f,l,e.areas):f.onload=()=>{this.setAreas(f,l,e.areas)})}else if(e.igrama!==void 0){const l=document.createElement("div");l.className="storyimage-container",o.appendChild(l);const a=this.expandIgrama(e.igrama);e.igramaText=this.getIgramaText(a),this.igramaDataUrl(a,this.options.igramaFormat).then(f=>{const u=new Image;u.src=f,u.className="storyimage",l.appendChild(u)})}if(e.title||e.titulo){const l=document.createElement("div");l.className="storytitle-container",o.appendChild(l);const a=document.createElement("h1");a.className="storytitle",a.textContent=e.title||e.titulo,l.appendChild(a)}if(e.meta!==void 0){const l=document.createElement("div");l.className="storymeta-container",o.appendChild(l);const a=this.data.find(f=>f.ID==e.meta);for(let f of this.metaKeys){if(a[f]===void 0)continue;const u=document.createElement("div");u.className="storymeta-subcontainer",l.appendChild(u);const c=document.createElement("span");c.className="storymeta-key",c.textContent=`${f}: `,u.appendChild(c);const d=document.createElement("span");d.className="storymeta-val",d.textContent=a[f],u.appendChild(d)}}const i=document.createElement("div");i.className="storyp-container",(e.text||e.texto||e.igramaText)&&o.appendChild(i);const r=document.createElement("p");if(r.className="storyp",r.textContent="",i.appendChild(r),e.url){const l=document.createElement("a");l.className="storyurl",l.href=e.url,l.target="_blank",l.textContent=this.options.urlWord,i.appendChild(l)}this.options.adventureSlide&&document.getElementById("storygeneraldiv").scrollIntoView({behavior:"smooth",block:"end"}),this.typewriter(r,e),this.data&&(e.viz!==void 0?this.prevScene=e.key:e.dataScene===!0&&(e.options[0].scene=this.prevScene)),this.options.sceneCallback(e)}setAreas(e,t,n){const o=e.getBoundingClientRect(),i=t.getBoundingClientRect();window.onresize=()=>{document.getElementsByClassName("storyimage-area").length>0&&this.setAreas(e,t,n)},[...document.getElementsByClassName("storyimage-area")].map(l=>l.remove());for(let l of n){let a=document.createElement("div");a.className="storyimage-area";const f=(l.x-Math.floor(l.w/2))*o.width/e.naturalWidth;a.style.left=`${o.left-i.left+f}px`;const u=(l.y-Math.floor(l.h/2))*o.height/e.naturalHeight;a.style.top=`${o.top-i.top+u}px`,a.style.width=`${l.w*o.width/e.naturalWidth}px`,a.style.height=`${l.h*o.height/e.naturalHeight}px`,a.textContent=l.btn||"",f>0&&f<o.width&&u>0&&u<o.height&&t.appendChild(a),a.style.fontSize=`${18*o.height/e.naturalHeight}px`,a.onclick=()=>{const c=l.scene||l.escena;this.goToScene(this.scenes[c])},l.tooltip!==void 0&&(a.onmouseover=()=>{a.textContent=l.tooltip||"",a.style.zIndex="100"},a.onmouseout=()=>{a.textContent=l.btn||"",a.style.zIndex="0"})}}async typewriter(e,t){const n=t.text||t.texto||t.igramaText||"";let o=this.grammar?this.grammarRuleRecursion(n):n;if(o=o.replace(/\n/g,"<br>"),this.options.typewriterSpeed>0){let i=0;await new Promise(r=>{const l=setInterval(()=>{const a=o.substring(0,i);this.options.evalTags?e.innerHTML=a:e.textContent=a,i++,i>o.length&&(clearInterval(l),r(!0))},Math.floor(this.options.typewriterSpeed))}),this.optionButtons(t)}else this.options.evalTags?e.innerHTML=o:e.textContent=o,this.optionButtons(t)}optionButtons(e){const t=[...document.getElementsByClassName("storydiv")],n=t[t.length-1];[...document.getElementsByClassName("storybutton-container")].map(r=>r.remove());const i=document.createElement("div");if(i.className="storybutton-container",n.appendChild(i),e.options||e.opciones){const r=e.options||e.opciones;for(let l of r){const a=document.createElement("button");a.className="storybutton",a.textContent=l.btn,i.appendChild(a),a.addEventListener("click",()=>{if((l.text||l.texto)===void 0){const u=l.scene||l.escena;this.goToScene(this.scenes[u])}else this.goToScene(l)})}}else if(e.scene||e.escena){const r=e.scene||e.escena,l=document.createElement("button");l.className="storybutton",l.textContent=this.lang==="en"?"Continue":"Continuar",i.appendChild(l),l.addEventListener("click",()=>{this.goToScene(this.scenes[r])})}this.options.adventureSlide&&document.getElementById("storygeneraldiv").scrollIntoView({behavior:"smooth",block:"end"})}selectGrammarRule(e){if(e.length===0)return"";if(e.prob){const o=Math.random()*e.prob.reduce((r,l)=>r+l);let i=0;for(let r=0;r<e.prob.length;r++){if(i<=o&&o<i+e.prob[r])return e[r];i+=e.prob[r]}}const t=Math.floor(Math.random()*e.length);return e[t]}getNestedObject(e,t){return t.reduce((n,o)=>n&&n[o]!==void 0?n[o]:void 0,e)}defineTransformations(e){let t={};const n=/#(?<trans>[\w\d,]+)#/gi.exec(e),o=n?n.groups.trans.match(/[\w]+/gi):[];for(let i of o)t[i]=!0;return t}transformString(e,t){let n=e;return t.CAPITALIZE&&(n=n.charAt(0).toUpperCase()+n.slice(1)),t.ALLCAPS&&(n=n.toUpperCase()),n}decodeDrawing(e){if(e==="")return[];const[t,n,o]=e.split("%%");let i={};return t==="vector"?i.content=n.split("**").map(r=>{const[l,a,f]=r.split("&"),u=[];if(u.color=l,u.weight=a,f===void 0)return u;const c=f.split(",");for(let d=0;d<c.length;d+=2)u.push([+c[d],+c[d+1]]);return u}):i.content=n,i.attribute=o,i.type=t,i}async getMarkovModel(e,t=1,n=!1){let o=await(await fetch(`./${e}`)).text();o=o.replace(/([,:.;])/g," $1").replace(/[()\¿¡!?”“—-]/g,"").toLowerCase();const i=o.split(this.markovSeparator),r={};for(let a=0;a<i.length-t;a++){let f="";for(let c=0;c<t;c++)f+=c===0?i[a+c]:" "+i[a+c];r[f]===void 0&&(r[f]={});const u=i[a+t];r[f][u]===void 0?r[f][u]=1:r[f][u]++}const l={};for(let a of Object.keys(r)){const f=Object.keys(r[a]);l[a]={probs:[],grams:f};let u=0;for(let c=0;c<f.length;c++)u+=r[a][f[c]];for(let c=0;c<f.length;c++)l[a].probs[c]=r[a][f[c]]/u}if(n){const a=e.split("/");this.saveJSON(l,`${a[a.length-1]}_markovModel_${t}N.json`)}return l}markovChain(e,t,n=.1){let o=t===void 0||this.markov[t]===void 0?this.randomMarkovWord():t,i=o;for(let l=0;l<e-1;l++){let a=this.getNextMarkov(this.markov[i]);a===void 0&&(a=this.getNextMarkov(this.randomMarkovWord()));let f=i.split(this.markovSeparator);f.push(a),f=f.slice(1).join(" "),i=f,o+=` ${a}`}return this.formatMarkov(o,n)}randomMarkovWord(){const e=Math.floor(Math.random()*Object.keys(this.markov).length);return Object.keys(this.markov)[e]}getNextMarkov(e){const t=Math.random();let n=0;if(e!==void 0)for(let o=0;o<e.probs.length;o++){if(n<=t&&t<n+e.probs[o])return e.grams[o];n+=e.probs[o]}}formatMarkov(e,t=.1){let n=e.replace(/ ([,:.;])/g,"$1");return n=n.replaceAll(/([.]) ([\wáéíóú])/ig,(o,i,r,l,a)=>Math.random()<t?`.
${r.toUpperCase()}`:`. ${r.toUpperCase()}`),n.charAt(0).toUpperCase()+n.slice(1)}async loadJSON(e){return await(await fetch(e)).json()}saveJSON(e,t){const n=document.createElement("a");n.href=URL.createObjectURL(new Blob([JSON.stringify(e,null,2)],{type:"application/json"})),n.setAttribute("download",`${t.includes(".json")?t:t+".json"}`),document.body.appendChild(n),n.click(),document.body.removeChild(n)}testScenes(e){const t=e||this.scenes;if(!t){const o=this.lang==="es"?"No hay escenas para probar":"There are not scenes to test";console.error(o)}let n=[];for(let o of Object.keys(t)){const i=t[o];if(i.options||i.opciones){const l=(i.options||i.opciones).filter(a=>!t[a.scene||a.escena]);n=[...n,...l.map(a=>`${o} => ${a.btn} => ${a.scene||a.escena}`)]}else{if(i.deadEnd||i.sinSalida)continue;t[i.scene||i.escena]||n.push(`${o} => ${i.scene||i.escena}`)}}if(n.length>0){const o=this.lang==="es"?`Las siguientes escenas no llevan a ningún lado: ${n.join(", ")}`:`The following scenes are dead ends: ${n.join(", ")}`;console.error(o),this.scenesError=!0}return this}testGrammar(e){const t=e||this.grammar;if(!t){const n=this.lang==="es"?"No hay gramática para probar":"There is not grammar to test";console.error(n)}for(let n of Object.keys(t)){const o=t[n];for(let i of o){const r=i.match(/<([\w\d]+)>/gi),l=r?r.map(c=>c.replace(/[<>]/g,"")):[],a=i.match(/\$[\w\d]+\$\[([\w\d.,:]+)\]/gi),f=a?a.map(c=>c.match(/([ ]?:[\w\d]+)/g).map(d=>/[ ]?:(?<key>[\w\d]+)/.exec(d).groups.key)).reduce((c,d)=>[...c,...d],[]):[],u=[...l,...f].filter(c=>!t[c]);if(u.length>0){const c=this.lang==="es"?`Las siguientes reglas, que se referencian en "${n}", no existen: ${u.join(", ")}`:`The following rules, referenced in "${n}", do not exist: ${u.join(", ")}`;this.grammarError=!0,console.error(c)}}}return this}testDistribution(e){const t=e||this.markov;if(t===void 0){const f=this.lang==="es"?"No hay modelo Markov para probar":"There is not Markov model to test";console.error(f)}const n={},o={};let i=0;const r=Object.values(t);for(let f of r)for(let u of f.probs){const c=(Math.round(u/.05)*.05).toFixed(2);o[i]=c,i++,n[c]===void 0?n[c]=1:n[c]++}console.log("------------------------------------ DIST ------------------------------------");const l=Math.max(...Object.values(n)),a=Object.entries(n).sort((f,u)=>f[0]>u[0]?1:f[0]<u[0]?-1:0);for(let f of a)console.log(`${f[0]}... ${"|".repeat(Math.ceil(f[1]*100/l))}`);return console.log("------------------------------------ DIST ------------------------------------"),this}async showIgrama(e,t="png",n){const o=await this.igramaDataUrl(e,t),i=new Image;i.src=o,n==null?document.body.appendChild(i):document.getElementById(n).appendChild(i)}async igramaDataUrl(e,t="png"){const n=this.igrama.metadata.width,o=this.igrama.metadata.height;let i=document.createElement("canvas");i.width=n,i.height=o;const r=i.getContext("2d");r.lineJoin="round",r.lineCap="round",r.fillStyle=this.igrama.metadata.bg||"#FFFFFF",r.fillRect(0,0,n,o),await this.drawLayers(e,r);let l;if(t==="png")l=i.toDataURL();else if(t==="gif"){if(typeof MiniGif>"u")return console.error(this.lang==="es"?"Para crear Gifs debes tener también la librería MiniGif":"To create Gifs you must have also the MiniGif library"),"";const a={colorResolution:7,dither:!1,delay:50};Object.assign(a,this.minigifOptions);const f=new MiniGif(a);f.addFrame(i);const u=this.getLayerWiggle(e);r.fillStyle=this.igrama.metadata.bg||"#FFFFFF",r.fillRect(0,0,n,o),await this.drawLayers(u,r),f.addFrame(i);const c=f.makeGif();l="data:image/gif;base64,"+await this.base64_arraybuffer(c)}return i.remove(),l}async base64_arraybuffer(e){return(await new Promise(n=>{const o=new FileReader;o.onload=()=>n(o.result),o.readAsDataURL(new Blob([e]))})).split(",",2)[1]}getLayerWiggle(e){const n=JSON.parse(JSON.stringify(e)),o=(i,r)=>Math.floor(i+Math.random()*(r-i));for(let[i,r]of n.entries())if(r.type==="vector")for(let[l,a]of r.content.entries()){for(let[f,u]of a.entries())Math.random()<.5?u[0]+=o(-3,3):u[1]+=o(-3,3);a.color=e[i].content[l].color,a.weight=e[i].content[l].weight}return n}getIgramaText(e){return e.map(n=>n.attribute).reverse().join(" ").trim()}async drawLayers(e,t){for(let[n,o]of e.entries())if(o.type==="url"){const{w:i,h:r,x:l,y:a}=this.igrama.sections[n];if(this.imgsMemo[o.content]===void 0){const f=new Image;f.src=o.content,this.imgsMemo[o.content]=await new Promise(u=>{f.addEventListener("load",()=>{u(f)},!1)})}t.drawImage(this.imgsMemo[o.content],l,a,i,r)}else if(o.type=="vector")for(let i of o.content){if(i.length===0)continue;const r=this.getSpline(i);this.drawSpline(r,t,i.color,i.weight)}}drawSpline(e,t,n,o){t.lineWidth=o,t.strokeStyle=n,t.fillStyle="rgba(0,0,0,0)",t.beginPath();for(let i=0;i<e.length;i++)i===0?t.moveTo(...e[0]):t.lineTo(...e[i]);t.stroke()}getSpline(e){let t=[];for(let n=0;n<e.length-1;n++){const o=[];o[0]=n>0?e[n-1]:e[0],o[1]=e[n],o[2]=e[n+1],o[3]=n<e.length-2?e[n+2]:e[e.length-1];for(let i=0;i<1;i+=.05){const r=this.getSplinePoint(i,o);t.push(r)}}return t}getSplinePoint(e,t){const n=Math.floor(e)+1,o=n+1,i=o+1,r=n-1,l=e*e,a=l*e,f=-a+2*l-e,u=3*a-5*l+2,c=-3*a+4*l+e,d=a-l,h=.5*(t[r][0]*f+t[n][0]*u+t[o][0]*c+t[i][0]*d),S=.5*(t[r][1]*f+t[n][1]*u+t[o][1]*c+t[i][1]*d);return[h,S]}setCSS(){const e=document.createElement("style");e.id="adventurestyle",e.innerHTML=an,document.getElementsByTagName("head")[0].appendChild(e)}}
  </script>
  <script>
    const scenes = {"Escena_1_El_Umbral_de_los_Susurros":{"text":"El aire vibra con magia inquieta. Finn está al borde del Bosque Hueco, donde los árboles se retuercen y su corteza sangra sombras. El viento gime: \"Entra, hijo de la oscuridad...\" ¿Qué hace Finn?","display":{"x":818,"y":275},"options":[{"btn":"Avanzar, tentado por el llamado.","scene":"Escena_2_La_Llamada_de_la_Oscuridad"},{"btn":"Invocar un escudo protector, desconfiado.","scene":"Escena_3_Senales_y_Advertencias"},{"btn":"Retirarse—algunos secretos no valen la pena.","scene":"Escena_4_Final_–_Huida"}]},"Escena_2_La_Llamada_de_la_Oscuridad":{"text":"Finn entra al bosque. Las sombras se arrastran hacia sus pezuñas, y las voces se vuelven claras: \"Libéranos...\" Al frente, un charco de oscuridad líquida gira en el corazón del bosque.\n¿Qué hace Finn?","display":{"x":187,"y":509},"options":[{"btn":"Tocar el charco, buscando respuestas.","scene":"Escena_5_Las_Profundidades_Oscuras"},{"btn":"Invocar una daga de sombra, listo para luchar.","scene":"Escena_6_Batalla_en_las_Sombras"},{"btn":"Cantar una canción tradicional del Feywild para calmar las voces.","scene":"Escena_7_La_Cancion_Perdida"}]},"Escena_3_Senales_y_Advertencias":{"text":"Finn dibuja un sigilo en el aire, y un escudo brillante lo protege. Las sombras retroceden, pero no antes de que vea una figura entre los árboles: una bruja del crepúsculo, sonriendo con malicia. ¿Qué hace Finn?","display":{"x":879,"y":734},"options":[{"btn":"Exigirle explicaciones.","scene":"Escena_8_La_Politica_Fey"},{"btn":"Atacarla con un rayo de sombra.","scene":"Escena_9_Traicion_y_Sombras"},{"btn":"Huir—esto es demasiado peligroso.","scene":"Escena_4_Final_–_Huida"}]},"Escena_4_Final_–_Huida":{"text":"Finn se retira. Los susurros del bosque se desvanecen, pero la corrupción permanece. (Quizás la próxima vez regrese más preparado...)\nFIN","display":{"x":1665,"y":670}},"Escena_5_Las_Profundidades_Oscuras":{"text":"Finn hunde su mano en el charco—un dolor helado lo recorre. Visiones lo inundan: una dríada encadenada por sombras, prisionera de la bruja. La dríada suplica: \"¡Destruye su talismán!\" ¿Qué hace Finn?","display":{"x":243,"y":918},"options":[{"btn":"Sumergirse en el charco, buscando el talismán.","scene":"Escena_10_El_Corazon_del_Talisman"},{"btn":"Retirarse y buscar aliados.","scene":"Escena_11_Final_–_Demora"}]},"Escena_6_Batalla_en_las_Sombras":{"text":"¡Las sombras se convierten en garras! Finn corta con su daga, pero una risa de bruja resuena: \"¡Tonto sátiro!\" Un mastín de las sombras emerge y ataca! ¿Qué hace Finn?","display":{"x":833,"y":987},"options":[{"btn":"Luchar con la daga.","scene":"Escena_12_Fuerza_contra_Sombra"},{"btn":"Usar magia para escapar.","scene":"Escena_2_La_Llamada_de_la_Oscuridad"},{"btn":"Usar su magia para desaparecer y emboscar a la bruja.","scene":"Escena_13_La_Emboscada_del_Satiro"}]},"Escena_7_La_Cancion_Perdida":{"text":"Finn canta una melodía antigua de los sátiros. Las sombras dudan... una dríada prisionera responde con un susurro: \"Eres de la Corte del Verano... ¿viniste a ayudarme?\" ¿Qué hace Finn?","display":{"x":1595,"y":1009},"options":[{"btn":"Prometer liberarla.","scene":"Escena_14_Promesa_de_Libertad"},{"btn":"Preguntarle por qué la bruja la capturó.","scene":"Escena_15_Secretos_del_Invierno"}]},"Escena_8_La_Politica_Fey":{"text":"La bruja se ríe: \"La Corte del Invierno me pagó bien por esta dríada. ¿O acaso la Corte del Verano te envió, pequeño sátiro?\" ¿Qué hace Finn?","display":{"x":356,"y":1291},"options":[{"btn":"Negociar—ofrecer algo a cambio.","scene":"Escena_16_Trato_Peligroso"},{"btn":"Atacar—no confía en sus mentiras.","scene":"Escena_9_Traicion_y_Sombras"}]},"Escena_9_Traicion_y_Sombras":{"text":"Finn lanza un hechizo, pero la bruja se desvanece en humo. ¡Era una ilusión! La verdadera bruja está detrás de él, con un puñal envenenado. ¿Qué hace Finn?","display":{"x":929,"y":1277},"options":[{"btn":"Usar Paso Brumoso para escapar.","scene":"Escena_17_Escape_Astuto"},{"btn":"Contraatacar con todo su poder.","scene":"Escena_18_El_Contraataque"}]},"Escena_10_El_Corazon_del_Talisman":{"text":"Finn se sumerge en la oscuridad. Allí, flotando, está un talismán de obsidiana. Las sombras lo rodean, susurrando secretos olvidados. ¿Qué hace Finn?","display":{"x":1570,"y":1299},"options":[{"btn":"Destruirlo con magia.","scene":"Escena_19_Liberacion"},{"btn":"Tomarlo para estudiarlo.","scene":"Escena_20_Final__Poder_Corrupto"}]},"Escena_11_Final_–_Demora":{"text":"Finn regresa con refuerzos, pero el Bosque Hueco ya está sellado. La bruja y la dríada han desaparecido. (¿Fue demasiado tarde?)\n\nFIN","display":{"x":355,"y":1576}},"Escena_12_Fuerza_contra_Sombra":{"text":"El mastín de las sombras ataca con colmillos brillantes. Finn canaliza su magia oscura en su daga y le da una estocada firme. El mastín se desintegra, pero las sombras lastiman a Finn. ¿Qué hace Finn?","display":{"x":997,"y":1562},"options":[{"btn":"Seguir adelante.","scene":"Escena_5_Las_Profundidades_Oscuras"},{"btn":"Regresar al umbral","scene":"Escena_1_El_Umbral_de_los_Susurros"}]},"Escena_13_La_Emboscada_del_Satiro":{"text":"Finn se desmaterializa en sombras y reaparece tras la bruja. Ella susurra: \"La Corte del Invierno te ofrecería más que la ingrata Corte del Verano...\" ¿Qué hace Finn?","display":{"x":1697,"y":1577},"options":[{"btn":"Aceptar negociar, fingiendo interés.","scene":"Escena_16_Trato_Peligroso"},{"btn":"Atacar con un Rayo de la Noche.","scene":"Final_6_Heroe_del_Verano"}]},"Escena_14_Promesa_de_Libertad":{"text":"La dríada llora: \"La bruja robó mi nombre para controlarme. Si lo recuperas, podré sanar el bosque.\" ¿Qué hace Finn?","display":{"x":153,"y":1808},"options":[{"btn":"Jurar recuperar su nombre, arriesgándose.","scene":"Final_X__Nombrame"},{"btn":"Pedir una recompensa de la Corte del Verano primero.","scene":"Final_4_Mercenario_Despreciado"}]},"Escena_15_Secretos_del_Invierno":{"text":"La dríada explica: \"La bruja sirve a la Princesa de Escarcha. Quieren debilitar al Verano usando este bosque. Ese es el plan de la Corte del Invierno.\" ¿Qué hace Finn?","display":{"x":933,"y":1799},"options":[{"btn":"Ofrecerse para sabotear los planes de la Corte del Invierno.","scene":"Escena_14_Promesa_de_Libertad"},{"btn":"Exigir pruebas antes de actuar.","scene":"Escena_6_Batalla_en_las_Sombras"}]},"Escena_16_Trato_Peligroso":{"text":"La bruja propone: \"Devuélveme el talismán, y te daré el nombre de la dríada... o sírvenme y obtendrás poder.\" ¿Qué hace Finn?","display":{"x":1614,"y":1876},"options":[{"btn":"Fingir aceptar e intentar robarla.","scene":"Escena_20_Final__Poder_Corrupto"},{"btn":"Rechazar y amenazar con exponerla al Verano.","scene":"Final_8_Equilibrio_del_Engano_"}]},"Escena_17_Escape_Astuto":{"text":"Finn usa Paso Brumoso para escapar, pero la bruja grita: \"¡El bosque ya está condenado!\". En su huida, Finn encuentra un espejo feérico que muestra el futuro. ¿Qué hace Finn?","display":{"x":182,"y":2110},"options":[{"btn":"Romper el espejo—ignorar las profecías.","scene":"Final_XX__Nueva_aventura_desbloqueada"},{"btn":"Consultar el espejo para encontrar el talismán.","scene":"Escena_10_El_Corazon_del_Talisman"}]},"Escena_18_El_Contraataque":{"text":"Finn canaliza toda su magia en un Núcleo de Oscuridad, pero el talismán responde, ofreciéndole poder ilimitado a cambio de su libertad. ¿Qué hace Finn?","display":{"x":934,"y":2084},"options":[{"btn":"Aceptar el poder y destruir a la bruja.","scene":"Final_5_Oscuridad_Justiciera"},{"btn":"Resistir, confiando en su propia fuerza.","scene":"Final_8_Equilibrio_del_Engano_"}]},"Intro_Sombras_del_Bosque_Hueco":{"text":"En lo profundo del Feywild, el Bosque Hueco—un lugar donde las sombras susurran—ha sido corrompido. Eres Finn, el Sátiro (Hechicero de las Sombras). Atraído por este llamado, Finn debe descubrir su secreto antes de que la oscuridad infecte las Cortes de los Faunos.","display":{"x":1038,"y":23},"options":[{"btn":"Personificar a Finn el Sátiro","scene":"Escena_1_El_Umbral_de_los_Susurros"}]},"Escena_20_Final__Poder_Corrupto":{"text":"Finn se deja corromper por el talismán. \"¿El fin justifica las sombras?\"","display":{"x":443,"y":2442}},"Escena_19_Liberacion":{"text":"Finn destruye el talismán. La dríada es libre.","display":{"x":1648,"y":2121},"options":[{"btn":"Aceptar la gratitud.","scene":"Final_X__Nombrame"},{"btn":"Rechazar y huir.","scene":"Escena_21_Final__Espiritu_Libre"}]},"Escena_21_Final__Espiritu_Libre":{"text":"Finn se funde con el bosque, burlándose de ambas Cortes. \"Las sombras son mi único aliado.\"","display":{"x":977,"y":2571}},"Final_4_Mercenario_Despreciado":{"text":"La Corte del Verano lo rechaza por avaro; Finn vaga solo. \"El oro feérico nunca brilla.\"","display":{"x":1445,"y":2573}},"Final_6_Heroe_del_Verano":{"text":"La bruja desaparece aparentemente destruida y la Corte del Verano lo honra, pero Finn rechaza el título que le orfecen. \"Prefiero ser libre que príncipe.\"","display":{"x":1960,"y":2309}},"Final_5_Oscuridad_Justiciera":{"text":"Finn usa el talismán para encerrar a la bruja, pero su alma se oscurece. \"Justicia... ¿o venganza?\"","display":{"x":868,"y":2344}},"Final_8_Equilibrio_del_Engano_":{"text":"Finn traiciona a la bruja y quema el talismán. \"Nadie controla a un sátiro.\"","display":{"x":1462,"y":2342}},"Final_X__Nombrame":{"text":"La dríada en tono poderoso relata un acertijo corto en lengua de las sombras la cual Finn reconoce de su infancia. Logra deducir su nombre: Callendulla. Al enunciarlo la dríada queda libre y guía a Finn a un refugio para pasar la noche y continuar sus aventuras tras el descanso anhelado.","display":{"x":21,"y":2375}},"Final_XX__Nueva_aventura_desbloqueada":{"text":"Al romper el espejo, Finn escucha susurros muy intensos y de repente se ve transportado mágicamente a un paisaje compleamte desconocido. Su aventura continuará...","display":{"x":95,"y":2627}}};
    const aventura = new A(lang, options);
    aventura.setScenes(scenes).startAdventure('Intro_Sombras_del_Bosque_Hueco');
  </script>
</html>
